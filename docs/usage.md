# Usage

**Work in progress**


`run.py` - (**deprecated**) is the main script for ocs-ci. You can view the
full usage details by passing in the `--help` argument.

For pytest usage run: run-ci --help

```bash
python run.py --help
```

## Required configuration

* **AWS credentials** - if you have AWS already configured by `aws configure`,
    see:
    [AWS doc](https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html)
    there shouldn't be need of any additional configuration for AWS. If not,
    please make sure you configure your AWS credentials via `aws configure`
    command, or you have proper configuration done in `~/.aws` folder which is
    usually generated by mentioned command.

## Required arguments

There are a few arguments that are required ocs test execution:

* `--cluster-path <path>`

## Useful pytest arguments

Some non-required arguments that we end up using a lot. You can use
`run-ci  --help` to see all the parameters and description which you can pass
to the pytest.

* `--capture=no` - when using pdb or ipdb you have to turn of capture mode
    for pytest.
* `-m "tier1 and ecosystem"` - This will select just tests marked with
    tier1 and ecosystem marks.


### Parameters already converted to pytest:

* `--cluster-name <name>` - name of cluster.
* `--cluster-path <path>` - path to the directory which will
    contain all the installation/authentication information about the cluster.
    If the information given can not be used to access the cluster then
    test execution will fail. If you wish to deploy a new cluster, give
    a path to a new directory and also use the `--deploy` argument.
* `--ocsci-conf` - with this configuration you can overwrite the default
    OCS-CI parameters defined in `conf/ocsci/default_config.yaml`
* `--cluster-conf` - with this configuration you can overwrite the default
    parameters for cluster and deployment. See the example of such file
    [here](../conf/ocs_basic_install.yml).
* `--deploy` - if this is given and a cluster can not be accessed from the
    provided `--cluster-path` then a new test cluster will be deployed.
* `--teardown` - if this is given the testing cluster will be destroyed after
    the test have completed, regardless of if the tests passed or failed.

### Parameters for old runner:

>TODO: Delete this section once moved to pytest and move missing parameters above!

* `--cluster-name <name>` - name of cluster.
* `--cluster-path <path>` - path where to create the directory which will
    contains all the installation/authentication information about cluster.
    `Use this parameter when running on already deployed cluster!` You can
    pass the cluster path from previous execution if was created automatically.
* `--conf` - with this configuration you can overwrite the default
    parameters for cluster and deployment. See the example of such file
    [here](../conf/ocs_basic_install.yml).
* `--no-destroy` - this will prevent you to destroy your cluster at the end of
    the execution. (Recommended if you want to re-run on the same cluster)
* `--log-level <level>` - set the log level that is output to stdout.

## Examples

### For old runner

* Run OCS install suite:

```bash
python run.py --suite suites/ocs_basic_install.yml --log-level info
```

* Run with specific name of cluster and cluster directory without sending email:

```bash
python run.py --cluster-name=my-testing-cluster \
    --suite=suites/custom-test.yml \
    --cluster-path=/home/your_login/my-testing-cluster \
    --no-email
```

### For pytest

Deployment and teardown of the test cluster can be done automatically with
the `--deploy` and `--teardown` arguments. The `--cluster-path` must always be
provided and if given without the `--deploy` argument, it must contain information
that can be used to access an existing cluster.

> In case you lost your cluster dir, the destroy can be done with
> `uni-cleanup.sh` script.



#### Deployment of cluster

Deployment is moved already to pytest. If you would like to deploy new cluster
you can run following command:
```bash
run-ci -m deployment --ocsci-conf conf/ocsci/custom_config.yaml \
    --cluster-conf conf/ocs_basic_install.yml \
    --cluster-name kerberos_ID-ocs-deployment \
    --cluster-path /home/my_user/my-ocs-dir tests/ \
    --deploy
 ```
of course you can utilize your cluster to add `--cluster-conf` parameter or
you can omit --cluster-name if you would like to use default
values.

Note that during deployment, openshift command line tools like `oc` and
`openshift-install` are installed into [`bin` directory of the
repository](../bin). These tools are then available to both deployment and test
code because `run-ci` wrapper includes the `bin` directoy into `PATH`
environment variable.

#### Runing tests on deployed environment

```bash
run-ci -m "tier1 and manage" \
    --cluster-name kerberos_ID-ocs-deployment \
    --cluster-path /home/my_user/my-ocs-dir tests/
 ```

#### Destroy of cluster

Destroy is moved already to pytest. If you would like to destroy existing
cluster you can run following command:
```bash
run-ci -m deployment \
    --cluster-name kerberos_ID-ocs-deployment \
    --cluster-path /home/my_user/my-ocs-dir tests/ \
    --teardown
 ```
